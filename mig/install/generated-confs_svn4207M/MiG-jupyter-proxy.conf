
<IfDefine DAG_URL>
    Header add Set-Cookie "DAG_ROUTE_ID=.%{BALANCER_WORKER_ROUTE}e; path=/dag" env=BALANCER_ROUTE_CHANGED
    <Proxy balancer://dag_hosts>
        BalancerMember ${JUPYTER_DAG_0} route=0 retry=600 timeout=40

        ProxySet stickysession=DAG_ROUTE_ID
    </Proxy>
    # Websocket cluster
    <Proxy balancer://ws_dag_hosts>
        BalancerMember ${WS_JUPYTER_DAG_0} route=0 retry=600 timeout=40

        ProxySet stickysession=DAG_ROUTE_ID
    </Proxy>
    <Location /dag>
        ProxyPreserveHost on
        ProxyPass balancer://dag_hosts/dag
        ProxyPassReverse balancer://dag_hosts/dag
        RequestHeader set Remote-User %{PROXY_USER}e
    </Location>
    <LocationMatch "/dag/(user/[^/]+)/(api/kernels/[^/]+/channels|terminals/websocket)/?">
        ProxyPass   balancer://ws_dag_hosts
        ProxyPassReverse    balancer://ws_dag_hosts
    </LocationMatch>
</IfDefine>
